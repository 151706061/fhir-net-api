map "http://uk-koeln.de/fhir/StructureMap/CTSTransportMap" = CTSTransportMap

uses "http://uk-koeln.de/fhir/StructureDefinition/CTS_Transport" as source
uses "http://hl7.org/fhir/StructureDefinition/Patient" as target
uses "http://hl7.org/fhir/StructureDefinition/Coverage" as target
uses "http://hl7.org/fhir/StructureDefinition/Bundle" as produced // How to specify that all generated instances are put into a bundle?

group Main(source src: CTS_Transport, target tgt: Patient)
{
	src.patid -> tgt.id;

    src.operations as operations then 
	{
		operations.data as data then 
		{
			data.values as values where (blockindex = '1' and groupindex = '0' and itemid = 'id_1131') then
			{ 
                values.value -> target.gender "rule_make_gender";
            } "rule_select_gender";

            data.values as values where (blockindex = '1' and groupindex = '0' and itemid = 'id_1128') then
			{
                values.value as value -> target.address as adress, address.postalCode = value "rule_make_postalCode";
            } "rule_select_postalCode";

            data.values as values where index = "1_0_id_1125" {
               values.value as value -> target.name.given = value "rule_make_name"
            } "rule_select_name";
        }
    }
}

group coverage for Coverage
    input "source" : CTS_Transport as source
    input "target" : Coverage as target

    "rule_operations_coverage": for source.operations as operations then {
        "rule_data_coverage" : for operations.data as data then {
            "rule_select_type": for data.values as values where data.index = "5_0_id_1269" {
                "rule_make_type": for values.value as value make target.type = value
            }
            "rule_select_payor_display": for data.values as values where data.index = "5_0_id_1272" {
                "rule_make_payor_display": for values.value as value make target.payor.display = value
            }
            "rule_select_extension_pkvTarifform": for data.values as values where data.index = "5_0_id_1270" {
                "rule_make_extension_pkvTarifform": for values.value as value make target.extension.pkvTarifform = value
            }
        }
    }
endgroup